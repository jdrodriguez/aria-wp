!function(e){"use strict";class t{constructor(){this.init(),this.bindEvents()}init(){e.fn.wpColorPicker&&e(".aria-color-picker").wpColorPicker(),this.initTooltips(),e("#aria-conversation-chart").length&&this.initDashboardCharts(),e(".aria-personality-form").length&&this.initPersonalityPreview(),e(".aria-design-form").length&&this.initDesignPreview()}bindEvents(){e(document).on("click",".aria-stat-card",this.handleStatCardClick.bind(this)),e(document).on("click","#add-custom-response",this.addCustomResponse.bind(this)),e(document).on("click",".aria-remove-response",this.removeCustomResponse.bind(this)),e(document).on("click",".aria-import-trigger",this.handleImport.bind(this)),e(document).on("change",'input[name="business_type"]',this.updateRecommendedTone.bind(this)),e(document).on("change",'input[name="tone_setting"], input[name="personality_traits[]"]',this.updatePersonalityPreview.bind(this)),e(document).on("input","#greeting_message",this.updateGreetingPreview.bind(this)),e(document).on("change",'input[name="button_icon"]',this.handleIconChange.bind(this)),e(document).on("change","#show_avatar",this.toggleAvatarOptions.bind(this)),e(document).on("change",'input[name="avatar_style"]',this.handleAvatarChange.bind(this)),e(document).on("click","#upload_icon_button",this.openMediaUploader.bind(this,"icon")),e(document).on("click","#upload_avatar_button",this.openMediaUploader.bind(this,"avatar")),e(document).on("click",".aria-device-btn",this.switchDevicePreview.bind(this)),e(document).on("change","#ai_provider",this.switchAIProvider.bind(this)),e(document).on("click","#toggle-api-key",this.toggleApiKey.bind(this)),e(document).on("click","#test-api-connection",this.testApiConnection.bind(this)),e(document).on("click","#test-saved-api",this.testSavedApiKey.bind(this)),e(document).on("input","#openai_temperature",this.updateTemperatureValue.bind(this)),e(document).on("change","#cb-select-all",this.toggleAllCheckboxes.bind(this)),e(document).on("click","#mark-resolved, #mark-unresolved",this.updateConversationStatus.bind(this)),e(document).on("click","#email-transcript",this.emailTranscript.bind(this)),e(document).on("click","#add-note",this.addConversationNote.bind(this)),e(document).on("change",'.aria-schedule-table input[type="checkbox"]',this.toggleScheduleInputs.bind(this)),e(document).on("change",'input[name="show_on_pages[]"][value="all"]',this.handleShowOnAllPages.bind(this)),e(document).on("click","#deactivate-license",this.deactivateLicense.bind(this)),e(document).on("click",".aria-retry-failed",this.retryFailedProcessing.bind(this)),e(document).on("submit",".aria-settings-form",this.handleFormSubmit.bind(this))}initTooltips(){e(".aria-tooltip").each(function(){e(this).tooltip({position:{my:"center bottom-10",at:"center top",using:function(t,a){e(this).css(t),e("<div>").addClass("aria-tooltip-arrow").addClass(a.vertical).addClass(a.horizontal).appendTo(this)}}})})}initDashboardCharts(){const e=document.getElementById("aria-conversation-chart");e&&new Chart(e,{type:"line",data:{labels:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],datasets:[{label:"Conversations",data:[12,19,15,25,22,30,28],borderColor:"#2271b1",backgroundColor:"rgba(34, 113, 177, 0.1)",tension:.4}]},options:{responsive:!0,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})}initPersonalityPreview(){this.personalityPreviewTimer=null,this.updatePersonalityPreview()}initDesignPreview(){this.designPreviewTimer=null,this.updateDesignPreview()}handleStatCardClick(t){switch(e(t.currentTarget).data("stat-type")){case"conversations":window.location.href=ariaAdmin.adminUrl+"admin.php?page=aria-conversations";break;case"knowledge":window.location.href=ariaAdmin.adminUrl+"admin.php?page=aria-knowledge";break;case"license":window.location.href=ariaAdmin.adminUrl+"admin.php?page=aria-settings&tab=license"}}addCustomResponse(t){t.preventDefault();const a=e("#custom-responses-container"),i=e(".aria-custom-response-row:first").clone();i.find("input, textarea").val(""),a.append(i)}removeCustomResponse(t){t.preventDefault();const a=e(t.currentTarget).closest(".aria-custom-response-row");e(".aria-custom-response-row").length>1?a.fadeOut(300,function(){e(this).remove()}):a.find("input, textarea").val("")}handleImport(t){t.preventDefault();const a=e(t.currentTarget).data("type");alert(`Import feature for ${a} coming soon!`)}updateRecommendedTone(t){const a=e(t.target).val();e(".aria-tone-option").removeClass("recommended"),e(`.aria-tone-option[data-business-type="${a}"]`).addClass("recommended")}updatePersonalityPreview(){clearTimeout(this.personalityPreviewTimer),this.personalityPreviewTimer=setTimeout(()=>{const t=e('input[name="tone_setting"]:checked').val(),a=[];e('input[name="personality_traits[]"]:checked').each(function(){a.push(e(this).val())}),this.updatePreviewMessage("greeting",t,a),this.updatePreviewMessage("product",t,a),this.updatePreviewMessage("unknown",t,a)},300)}updatePreviewMessage(t,a,i){const n={greeting:{professional:"Hello. I'm Aria, your assistant. How may I help you today?",friendly:"Hi! I'm Aria, and I'm here to help. What brings you here today?",casual:"Hey there! I'm Aria ðŸ‘‹ What can I help you with?"},product:{professional:"I'd be happy to provide information about our products. We offer a comprehensive range of solutions designed to meet your business needs.",friendly:"I'd love to tell you about our products! We have some great options that might be perfect for what you're looking for.",casual:"Sure thing! Let me tell you about our awesome products - I think you'll really like what we have to offer!"},unknown:{professional:"I apologize, but I don't have information about that specific topic. Would you like me to connect you with a specialist who can assist you?",friendly:"Hmm, I'm not sure about that one, but I'd be happy to find someone who can help you with this question!",casual:"Oops, that's not something I know about yet! But hey, let me get someone who can definitely help you out!"}},s=n[t][a]||n[t].professional;e(`#preview-${t}`).text(s)}updateGreetingPreview(t){const a=e(t.target).val()||"Hello! I'm Aria. How can I help you today?";e("#preview-greeting").text(a)}handleIconChange(t){const a=e(t.target).val();e("#custom-icon-upload").toggle("custom"===a),this.updateDesignPreview()}toggleAvatarOptions(t){const a=e(t.target).is(":checked");e("#avatar-style-row").toggle(a),this.updateDesignPreview()}handleAvatarChange(t){const a=e(t.target).val();e("#custom-avatar-upload").toggle("custom"===a),this.updateDesignPreview()}openMediaUploader(t,a){a.preventDefault();const i=wp.media({title:"icon"===t?ariaAdmin.strings.chooseIcon:ariaAdmin.strings.chooseAvatar,button:{text:"icon"===t?ariaAdmin.strings.useIcon:ariaAdmin.strings.useAvatar},multiple:!1});i.on("select",()=>{const a=i.state().get("selection").first().toJSON();"icon"===t?(e("#custom_icon").val(a.url),e("#custom_icon_preview").html(`<img src="${a.url}" style="max-width: 60px; margin-left: 10px; vertical-align: middle;" />`)):(e("#custom_avatar").val(a.url),e('input[value="custom"] + .aria-avatar-preview').html(`<img src="${a.url}" />`)),this.updateDesignPreview()}),i.open()}switchDevicePreview(t){const a=e(t.currentTarget),i=a.data("device");e(".aria-device-btn").removeClass("active"),a.addClass("active"),e(".aria-preview-screen").toggleClass("mobile-view","mobile"===i)}updateDesignPreview(){clearTimeout(this.designPreviewTimer),this.designPreviewTimer=setTimeout(()=>{const t={position:e("#position").val(),theme:e("#theme").val(),primaryColor:e("#primary_color").val(),secondaryColor:e("#secondary_color").val(),textColor:e("#text_color").val(),buttonSize:e("#button_size").val(),buttonStyle:e("#button_style").val(),showAvatar:e("#show_avatar").is(":checked")};this.applyPreviewStyles(t)},300)}applyPreviewStyles(t){const a=e("#aria-preview-widget");a.removeClass("position-bottom-right position-bottom-left position-bottom-center").addClass("position-"+t.position),a.removeClass("theme-light theme-dark").addClass("theme-"+t.theme),a.find(".aria-chat-header").css("background-color",t.primaryColor),a.find(".aria-chat-button-preview").css("background-color",t.primaryColor),a.find(".aria-message-user .aria-message-content").css("background-color",t.secondaryColor);const i={small:"50px",medium:"60px",large:"70px"};a.find(".aria-chat-button-preview").css({width:i[t.buttonSize],height:i[t.buttonSize]}),a.find(".aria-chat-button-preview").removeClass("style-rounded style-square style-circle").addClass("style-"+t.buttonStyle),a.find(".aria-message-avatar, .aria-avatar-preview-small").toggle(t.showAvatar)}switchAIProvider(t){const a=e(t.target).val();e(".aria-provider-settings").hide(),e(`#${a}-settings`).show(),this.updateApiKeyHelp(a)}updateApiKeyHelp(t){let a="";"openai"===t?a=`<p class="description">${ariaAdmin.strings.getApiKey} <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>. ${ariaAdmin.strings.apiKeyFormat}</p>`:"gemini"===t&&(a=`<p class="description">${ariaAdmin.strings.getApiKey} <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>.</p>`),e("#api-key-help").html(a)}toggleApiKey(t){t.preventDefault();const a=e("#api_key"),i=e(t.currentTarget),n="password"===a.attr("type");a.attr("type",n?"text":"password"),i.find(".dashicons").toggleClass("dashicons-visibility",!n).toggleClass("dashicons-hidden",n);const s=n?" Hide":" Show";i.contents().filter(function(){return 3===this.nodeType}).last().replaceWith(s)}testApiConnection(t){t.preventDefault();const a=e(t.currentTarget),i=e("#ai_provider").val();let n=e("#api_key").val();if(n=n?n.trim():"",!n||0===n.length)return a.prop("disabled",!0).find(".dashicons").addClass("spin"),void e.post(ariaAdmin.ajaxUrl,{action:"aria_test_saved_api",provider:i,nonce:ariaAdmin.nonce},e=>{if(a.prop("disabled",!1).find(".dashicons").removeClass("spin"),e&&e.success){const t=e.data&&e.data.message||ariaAdmin&&ariaAdmin.strings&&ariaAdmin.strings.apiConnected||"API connected successfully!";alert(t)}else{const t=e&&e.data&&e.data.message||ariaAdmin&&ariaAdmin.strings&&ariaAdmin.strings.apiError||"API connection failed. Please check your credentials.";alert(t)}}).fail((e,t,i)=>{a.prop("disabled",!1).find(".dashicons").removeClass("spin"),alert("Request failed: "+i)});if(-1!==n.indexOf("*")){const e=ariaAdmin&&ariaAdmin.strings&&ariaAdmin.strings.enterValidKey||"Please enter a valid API key.";return void alert(e)}a.prop("disabled",!0).find(".dashicons").addClass("spin"),e.post(ariaAdmin.ajaxUrl,{action:"aria_test_api",provider:i,api_key:n,nonce:ariaAdmin.nonce},e=>{if(a.prop("disabled",!1).find(".dashicons").removeClass("spin"),e&&e.success){const t=e.data&&e.data.message||ariaAdmin&&ariaAdmin.strings&&ariaAdmin.strings.apiConnected||"API connected successfully!";alert(t)}else{const t=e&&e.data&&e.data.message||ariaAdmin&&ariaAdmin.strings&&ariaAdmin.strings.apiError||"API connection failed. Please check your credentials.";alert(t)}}).fail((e,t,i)=>{a.prop("disabled",!1).find(".dashicons").removeClass("spin"),alert("Request failed: "+i)})}testSavedApiKey(e){e.preventDefault();const t=window.location.href,a=t.includes("?")?"&":"?";window.location.href=t+a+"test_key=1"}updateTemperatureValue(t){e("#temperature-value").text(e(t.target).val())}toggleAllCheckboxes(t){const a=e(t.target).is(":checked");e('input[name="conversation_ids[]"], input[name="knowledge_ids[]"]').prop("checked",a)}updateConversationStatus(t){const a=e(t.currentTarget),i=a.data("id"),n="mark-resolved"===a.attr("id")?"resolved":"active";e.post(ariaAdmin.ajaxUrl,{action:"aria_update_conversation_status",conversation_id:i,status:n,nonce:ariaAdmin.nonce},e=>{e.success?location.reload():alert(e.data.message||ariaAdmin.strings.error)})}emailTranscript(t){const a=e(t.currentTarget).data("id"),i=prompt(ariaAdmin.strings.enterEmail);i&&e.post(ariaAdmin.ajaxUrl,{action:"aria_email_transcript",conversation_id:a,email:i,nonce:ariaAdmin.nonce},e=>{e.success?alert(e.data.message):alert(e.data.message||ariaAdmin.strings.error)})}addConversationNote(t){const a=e(t.currentTarget).data("id"),i=prompt(ariaAdmin.strings.addNote);i&&e.post(ariaAdmin.ajaxUrl,{action:"aria_add_conversation_note",conversation_id:a,note:i,nonce:ariaAdmin.nonce},e=>{e.success?location.reload():alert(e.data.message||ariaAdmin.strings.error)})}toggleScheduleInputs(t){const a=e(t.target);a.closest("tr").find(".aria-time-inputs").toggle(a.is(":checked"))}handleShowOnAllPages(t){const a=e(t.target).is(":checked");e('input[name="show_on_pages[]"]:not([value="all"])').prop("checked",!1).prop("disabled",a)}deactivateLicense(t){confirm(ariaAdmin.strings.confirmDeactivate)&&(e("#license_key").val(""),e(t.target).closest("form").submit())}retryFailedProcessing(t){t.preventDefault();const a=e(t.target),i=a.data("nonce");confirm(ariaAdmin.strings.confirmRetryFailed||"Are you sure you want to retry failed processing entries?")&&(a.prop("disabled",!0).html('<span class="dashicons dashicons-update aria-spin"></span> '+(ariaAdmin.strings.retrying||"Retrying...")),e.post(ariaAdmin.ajaxUrl,{action:"aria_retry_failed_processing",nonce:i}).done(e=>{e.success?(alert(e.data.message||ariaAdmin.strings.retrySuccess||"Failed entries have been scheduled for retry."),location.reload()):alert(e.data.message||ariaAdmin.strings.retryError||"Failed to retry processing entries.")}).fail(()=>{alert(ariaAdmin.strings.ajaxError||"Request failed. Please try again.")}).always(()=>{a.prop("disabled",!1).text(ariaAdmin.strings.retryFailed||"Retry Failed")}))}handleFormSubmit(t){e(t.target).find('button[type="submit"]').prop("disabled",!0).text(ariaAdmin.strings.saving)}}e(document).ready(()=>{window.ariaAdmin=new t})}(jQuery);